<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../epic-slider/epic-slider.html" />
<link rel="import" href="../zeal-navbar/zeal-navbar.html" />
<link rel="import" href="../zeal-footer/zeal-footer.html" />
<link rel="import" href="../epic-contentful/epic-contentful.html" />
<link rel="import" href="../epic-polyfills/epic-polyfills.html" />
<link rel="import" href="include-masonry.html" />
<link rel="import" href="include-moment.html" />

<!--
An events landing page

Example:

    <epic-events-page></epic-events-page>

@demo
-->
<dom-module id="epic-events-page">
    <style>
        :host {
            display: block;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .main {
            width: 100%;
            background-image: url("img/decorative-texture-1.png");
            background-repeat: repeat
        }

        .main a {
            color: #666;
            text-decoration: none;
            text-transform: uppercase
        }

        .main h1 {
            text-align: center;
            font-size: 5em;
            padding: 1em 0;
            text-transform: uppercase;
            background-color: transparent
        }

        .main h2 {
            font-size: 42px;
            text-align: center;
            margin: 1em auto;
            font-weight: bold;
            text-transform: uppercase;
            line-height: normal
        }

        .heroTop {
            padding: 50px 1em;
            background: url("img/events-hero.jpg") center center no-repeat;
            background-size: cover;
            color: white;
        }

        .heroTop h1 {
            padding: 0;
            font-size: 5em;
            text-shadow: 0 0 20px rgba(51, 51, 51, 0.5);
            line-height: 300px
        }

        .pastEvents,
        .upcomingEvents {
            position: relative;
            width: 90%;
            margin: 0 auto;
            max-width: 1600px;
            display: flex;
            justify-content: flex-start;
            align-items: flex-start;
            align-content: flex-start;
            flex-flow: row wrap;
            /*
              Playing with a masonry-like display. Problems include that the order is top-down, then wrap... and that the container needs a fixed height.

                  justify-content: flex-start;
                  align-items: flex-start;
                  align-content: space-between;
                  flex-flow: column wrap;
            */
        }

        .pastEvents .event .card .imageBackground {
            position: relative
        }

        .pastEvents .event .card .imageBackground:after{
            content: ' ';
            background-color: transparent;
            background: linear-gradient(to top, #fff, transparent);
            width: 100%;
            height: 100%;
            position: absolute;
            left: 0;
            top: 0
        }

        .pastEvents .event .card .content {
          opacity: .6;
        }

        .pastEvents .event .card .content .details {
            display: none
        }

        .event {
            flex-basis: 33.33%;
            padding: 0 1em;
            box-sizing: border-box;
            margin: 0 0 30px;
        }

        .event .card {
            width: 100%;
            background: white;
            box-shadow: 0 0 5px #aaa
        }

        .event .card .imageBackground {
            font-size: 0;
            background-size: cover;
            padding-top: 60%;
            background-position: center center;
        }

        .event .card .content {
            padding: 15px;
            text-align: center
        }

        .event .card .content h2 {
            margin: 0;
            font-size: 1.6em;
        }

        .event .card .content h3 {
            /*font-weight: normal;*/
            /*font-size: 1em;*/
            padding: 0;
        }

        .event .card .content .details {
            border-right: 0;
            border-left: 0;
            padding: 0;
            text-align: left;
            display: flex;
            flex-flow: row nowrap;
            justify-content: flex-start;
            align-items: stretch;
        }

        .event .card .content .details p {
            display: inline-block;
            flex-basis: 50%;
            flex-grow: 1;
            margin-bottom: 0;
            padding-right: 1em;
        }

        .event .card .content > * {
            text-align: left
        }

        .event .card .content a.moreDetails {
            display: inline-block;
            background: #c30;
            padding: 1em 2em;
            margin: 1em auto;
            font-weight: bold;
            color: white;
            letter-spacing: .025em;
        }

        .event .card .content a.moreDetails:hover {
            background: #a52900;
            cursor: pointer;
        }

        @media screen and (max-width: 991px) {
            .heroTop h1 {
                line-height: 1em;
                padding: 1em 20px;
                font-size: 4em
            }
            .event {
                flex-basis: 50%;
            }
            .event .card .content h2 {
                font-size: 2rem
            }
            .event .card .content .eventDetails {
                font-size: 1rem
            }
            .event .card .content .moreDetails {
                font-size: 1rem
            }
        }

        @media screen and (max-width: 768px) {
            .heroTop {
                padding: 50px 1em
            }
            .heroTop h1 {
                font-size: 3em;
                line-height: 1.5em
            }
            .event {
                flex-basis: 100%;
                padding: 10px 0 !important
            }
        }
    </style>

    <template>
        <epic-contentful token="7293987ea91368b8cae485aeadc4037af8253ae4706e2fa0400f9a831aa93086" space="1kzutnf7jc3r" content-type="events">
            <epic-contentful-filter property="fields.slug" value="[[entrySlug]]"></epic-contentful-filter>
        </epic-contentful>

        <zeal-navbar></zeal-navbar>

        <div id="pageContent" class="main">
            <div class="heroTop">
                <h1>Events &amp; Happenings</h1>
            </div>

            <h2>Upcoming Events</h2>

            <div class="upcomingEvents">
                <template is="dom-repeat" items="{{events}}" filter="isUpcoming">
                    <div class="event">
                        <div class="card">
                            <div class="imageBackground" style$="background-image: url([[item.featuredImage]]);">
                            </div>
                            <div class="content">
                                <h2>[[item.name]]</h2>
                                <div class="details">
                                    <p class="location">[[item.locationString]]</p>
                                    <p class="startDate">[[item.startAndEnd]]</p>
                                </div>
                                <h3>[[item.teaser]]</h3>
                                <p class="eventDetails">[[item.truncatedDetails]]</p>
                                <a href="[[item.slug]]" class="moreDetails">Learn More</a>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <epic-slider min-height="500px" slides="{{featuredUpcomingEvents}}"></epic-slider>

            <h2>Past Events</h2>

            <div class="pastEvents">
                <template is="dom-repeat" items="{{events}}" filter="isPast">
                    <div class="event">
                        <div class="card">
                            <div class="imageBackground" style$="background-image: url([[item.featuredImage]]);">
                            </div>
                            <div class="content">
                                <h2>[[item.name]]</h2>
                                <div class="details">
                                    <p class="location">[[item.locationString]]</p>
                                    <p class="startDate">[[item.startAndEnd]]</p>
                                </div>
                                <h3>[[item.teaser]]</h3>
                                <p class="eventDetails">[[item.truncatedDetails]]</p>
                                <a href="[[item.slug]]" class="moreDetails">Learn More</a>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <zeal-footer></zeal-footer>

    </template>
</dom-module>

<script>
    Polymer({
        is: 'epic-events-page',

        properties: {
            events: {
                type: Array,
                value: function() {
                    return [];
                },
                notify: true
            },
            featuredUpcomingEvents: {
                type: Array,
                value: function() {
                    return [];
                },
                notify: true
            },
            maxDetailsChars: {
                Type: Number,
                value: 150
            }
        },

        observers: [
            'eventsChanged(events.splices)'
        ],

        ready: function() {
            this.querySelector('epic-contentful').addEventListener('response', (function(response) {
                this._handleContentfulResponse(response);
            }).bind(this));
        },

        isPast: function(event) {
            return !this.isUpcoming(event);
        },

        isUpcoming: function(event) {
            return moment(event.startDate).isAfter(moment());
        },

        isFeatured: function(event) {
            return event.featuredEvent == true;
        },

        eventsChanged: function(splices) {
          this.featuredUpcomingEvents = this.events.filter((function(element, index, array) {
              return (element.featuredEvent == true && this.isUpcoming(element))
          }).bind(this));
        },

        _handleContentfulResponse: function(response) {
            // build assetMap for quick lookup
            var assetMap = [];
            for (var i = 0; i < response.detail.value.includes.Asset.length; i += 1) {
                assetMap[response.detail.value.includes.Asset[i].sys.id] = response.detail.value.includes.Asset[i].fields;
            }

            // build entryMap for quick lookup
            if (response.detail.value.includes.Entry) {
                var entryMap = [];
                for (var i = 0; i < response.detail.value.includes.Entry.length; i += 1) {
                    entryMap[response.detail.value.includes.Entry[i].sys.id] = response.detail.value.includes.Entry[i].fields;
                }
            }

            // update this.events
            for (var i = 0; i < response.detail.value.items.length; i += 1) {
                // format event start date
                var longStartDate = moment(response.detail.value.items[i].fields.startDate).format("ddd, MMM D h:mmA"),
                    shortStartDate = moment(response.detail.value.items[i].fields.startDate).format("M/D/YY hA");

                /*
                  Time Formatting

                  If the event lasts more than one day, exclude the start/end time.
                  If the event is only one day, show the start and end times.

                  i.e.
                    Jun 30 6:00PM
                    Jun 30 - Jul 1
                */

                var startDay = moment(response.detail.value.items[i].fields.startDate).format("D"),
                    endDay = moment(response.detail.value.items[i].fields.endDate).format("D"),
                    startAndEnd,
                    truncatedDetails;

                if (startDay !== endDay) {
                    startAndEnd = moment(response.detail.value.items[i].fields.startDate).format("MMM D - ") + moment(response.detail.value.items[i].fields.endDate).format("MMM D");
                } else {
                    startAndEnd = moment(response.detail.value.items[i].fields.startDate).format("MMM D h:mmA");
                }

                // truncate event details to first x characters
                if (response.detail.value.items[i].fields.details && response.detail.value.items[i].fields.details.length > this.maxDetailsChars) {
                    truncatedDetails = response.detail.value.items[i].fields.details.substr(0, this.maxDetailsChars);
                    truncatedDetails += '...';
                } else {
                    truncatedDetails = response.detail.value.items[i].fields.details;
                }

                this.push('events', {
                    'blogUrl': response.detail.value.items[i].fields.blogUrl,
                    'details': response.detail.value.items[i].fields.details,
                    'endDate': response.detail.value.items[i].fields.endDate,
                    'externalUrl': response.detail.value.items[i].fields.externalUrl,
                    'featuredEvent': response.detail.value.items[i].fields.featuredEvent,
                    'featuredImage': assetMap[response.detail.value.items[i].fields.featuredImage.sys.id].file.url,
                    'locationString': response.detail.value.items[i].fields.locationString,
                    'name': response.detail.value.items[i].fields.name,
                    'slug': response.detail.value.items[i].fields.slug,
                    'startDate': response.detail.value.items[i].fields.startDate,
                    'teaser': response.detail.value.items[i].fields.teaser,
                    'video': response.detail.value.items[i].fields.video,
                    'truncatedDetails': truncatedDetails,
                    'startAndEnd': startAndEnd
                });
            }
        },
    })
</script>
